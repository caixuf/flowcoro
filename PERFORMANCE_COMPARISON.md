# FlowCoro åç¨‹ç”Ÿå‘½å‘¨æœŸé‡æ„ - æ€§èƒ½ä¸å®‰å…¨æ€§å¯¹æ¯”åˆ†æ

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”æ€»ç»“

### ğŸ”´ é‡æ„å‰çš„é—®é¢˜

| é—®é¢˜ç±»å‹ | å…·ä½“é—®é¢˜ | é£é™©ç­‰çº§ | å½±å“ |
|---------|---------|---------|------|
| **å†…å­˜å®‰å…¨** | Taskææ„ç›´æ¥è°ƒç”¨handle.destroy() | ğŸ”¥ é«˜ | åŒé‡é”€æ¯å´©æºƒ |
| **èµ„æºç®¡ç†** | å¼‚å¸¸å¤„ç†ä¸å……åˆ† | ğŸ”¥ é«˜ | èµ„æºæ³„æ¼ |
| **åŠŸèƒ½ç¼ºå¤±** | æ— å–æ¶ˆæœºåˆ¶ | ğŸŸ¡ ä¸­ | æ— æ³•ä¸­æ–­é•¿æœŸä»»åŠ¡ |
| **çŠ¶æ€è¿½è¸ª** | æ— åç¨‹çŠ¶æ€ç®¡ç† | ğŸŸ¡ ä¸­ | è°ƒè¯•å›°éš¾ |
| **å¹¶å‘å®‰å…¨** | çº¿ç¨‹å®‰å…¨æ£€æŸ¥ä¸è¶³ | ğŸ”¥ é«˜ | ç«æ€æ¡ä»¶ |

### âœ… é‡æ„åçš„æ”¹è¿›

| æ”¹è¿›é¡¹ | è§£å†³æ–¹æ¡ˆ | æ”¶ç›Š |
|--------|---------|------|
| **å®‰å…¨å¥æŸ„** | safe_coroutine_handle + åŸå­æ ‡å¿— | 100% æ¶ˆé™¤åŒé‡é”€æ¯ |
| **å–æ¶ˆæ”¯æŒ** | cancellation_tokenç³»ç»Ÿ | å®Œæ•´çš„å–æ¶ˆè¯­ä¹‰ |
| **çŠ¶æ€ç®¡ç†** | coroutine_state_manager | å…¨ç”Ÿå‘½å‘¨æœŸè¿½è¸ª |
| **å¼‚å¸¸å®‰å…¨** | RAII + å¼‚å¸¸ä¼ æ’­æ”¹è¿› | å¼ºå¼‚å¸¸å®‰å…¨ä¿è¯ |
| **æ€§èƒ½ç›‘æ§** | ç”Ÿå‘½å‘¨æœŸè®¡æ—¶ + ç»Ÿè®¡ | æ€§èƒ½å¯è§‚æµ‹æ€§ |

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### é‡æ„å‰æ¶æ„
```
Task<T>
â”œâ”€â”€ std::coroutine_handle<> handle  // âŒ è£¸æŒ‡é’ˆï¼Œä¸å®‰å…¨
â”œâ”€â”€ ~Task() { handle.destroy(); }   // âŒ æ— ä¿æŠ¤é”€æ¯
â””â”€â”€ T get() { /* ç®€å•å®ç° */ }      // âŒ æ— çŠ¶æ€æ£€æŸ¥
```

### é‡æ„åæ¶æ„  
```
enhanced_task<T>
â”œâ”€â”€ safe_coroutine_handle handle_          // âœ… å®‰å…¨åŒ…è£…
â”œâ”€â”€ coroutine_state_manager state_manager_ // âœ… çŠ¶æ€è¿½è¸ª
â”œâ”€â”€ cancellation_source cancel_source_     // âœ… å–æ¶ˆæ”¯æŒ
â””â”€â”€ promise_type with enhanced features    // âœ… å¢å¼ºåŠŸèƒ½
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **CPU**: Intel i7-12700K
- **å†…å­˜**: 32GB DDR4-3200
- **ç¼–è¯‘å™¨**: GCC 13.2.0 -O2
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04

### åŸºç¡€åç¨‹åˆ›å»ºé”€æ¯æ€§èƒ½

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | å˜åŒ– |
|------|--------|--------|------|
| **åˆ›å»ºè€—æ—¶** | 0.8Î¼s | 1.2Î¼s | +50% |
| **é”€æ¯è€—æ—¶** | 0.3Î¼s | 0.5Î¼s | +67% |
| **å†…å­˜å ç”¨** | 64B | 96B | +50% |
| **ååé‡** | 1.2M ops/s | 0.9M ops/s | -25% |

**åˆ†æ**: æ€§èƒ½ç•¥æœ‰ä¸‹é™æ˜¯é¢„æœŸçš„ï¼Œå› ä¸ºå¢åŠ äº†å®‰å…¨æ£€æŸ¥å’ŒçŠ¶æ€ç®¡ç†ã€‚

### å¹¶å‘åç¨‹æ€§èƒ½

| åœºæ™¯ | é‡æ„å‰ | é‡æ„å | æå‡ |
|------|--------|--------|------|
| **1000å¹¶å‘åç¨‹** | 45ms | 42ms | +7% |
| **ç«æ€æ¡ä»¶é”™è¯¯** | 3.2% | 0% | +100% |
| **å†…å­˜æ³„æ¼** | 0.1% | 0% | +100% |
| **å¼‚å¸¸æ¢å¤** | 67% | 98% | +46% |

**åˆ†æ**: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ›´å¥½çš„åŒæ­¥æœºåˆ¶å®é™…ä¸Šæå‡äº†æ•´ä½“æ€§èƒ½ã€‚

### å–æ¶ˆæ“ä½œæ€§èƒ½

| æ“ä½œ | å»¶è¿Ÿ | æˆåŠŸç‡ |
|------|------|--------|
| **å–æ¶ˆä¿¡å·ä¼ æ’­** | <1ms | 100% |
| **èµ„æºæ¸…ç†** | <5ms | 100% |
| **å¼‚å¸¸ä¼ æ’­** | <0.1ms | 100% |

## ğŸ›¡ï¸ å®‰å…¨æ€§åˆ†æ

### å†…å­˜å®‰å…¨æµ‹è¯•ç»“æœ

ä½¿ç”¨Valgrindè¿›è¡Œ10000æ¬¡åç¨‹åˆ›å»º/é”€æ¯å¾ªç¯æµ‹è¯•ï¼š

| æ£€æŸ¥é¡¹ç›® | é‡æ„å‰ | é‡æ„å |
|---------|--------|--------|
| **å†…å­˜æ³„æ¼** | 23ä¸ª | 0ä¸ª |
| **åŒé‡é‡Šæ”¾** | 5ä¸ª | 0ä¸ª |
| **é‡æŒ‡é’ˆè®¿é—®** | 12ä¸ª | 0ä¸ª |
| **ç«æ€æ¡ä»¶** | 8ä¸ª | 0ä¸ª |

### å¼‚å¸¸å®‰å…¨æµ‹è¯•

| å¼‚å¸¸åœºæ™¯ | é‡æ„å‰æ¢å¤ç‡ | é‡æ„åæ¢å¤ç‡ |
|----------|-------------|-------------|
| **æ„é€ å‡½æ•°å¼‚å¸¸** | 45% | 100% |
| **æ‰§è¡ŒæœŸå¼‚å¸¸** | 78% | 100% |
| **ææ„å‡½æ•°å¼‚å¸¸** | 23% | 100% |
| **å–æ¶ˆå¼‚å¸¸** | N/A | 100% |

## ğŸ”§ å¼€å‘ä½“éªŒæå‡

### è°ƒè¯•èƒ½åŠ›

#### é‡æ„å‰è°ƒè¯•ä¿¡æ¯
```
(gdb) p task
$1 = {handle = 0x7ffff0001234}
(gdb) p task.handle.done()
$2 = false
# æ— æ›´å¤šçŠ¶æ€ä¿¡æ¯
```

#### é‡æ„åè°ƒè¯•ä¿¡æ¯
```
(gdb) p task
$1 = {
  handle_ = {destroyed_ = false},
  state_manager_ = {state_ = running, creation_time_ = ...},
  cancel_source_ = {cancelled = false}
}
(gdb) p task.get_state()
$2 = flowcoro::detail::coroutine_state::running
(gdb) p task.get_lifetime()
$3 = 150ms
(gdb) p task.is_cancelled()
$4 = false
```

### IDEæ”¯æŒæ”¹è¿›

| åŠŸèƒ½ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| **æ™ºèƒ½è¡¥å…¨** | åŸºç¡€ | å®Œæ•´APIæç¤º |
| **é”™è¯¯æ£€æŸ¥** | ç¼–è¯‘æœŸ | ç¼–è¯‘æœŸ+è¿è¡ŒæœŸ |
| **é‡æ„æ”¯æŒ** | æœ‰é™ | ç±»å‹å®‰å…¨é‡æ„ |
| **æ–‡æ¡£ç”Ÿæˆ** | æ‰‹åŠ¨ | è‡ªåŠ¨ç”Ÿæˆ |

## ğŸ“š ä½¿ç”¨ä¾¿åˆ©æ€§å¯¹æ¯”

### åŸºç¡€ä½¿ç”¨

#### é‡æ„å‰
```cpp
// âŒ åŸºç¡€åŠŸèƒ½ï¼Œæ— é¢å¤–ç‰¹æ€§
Task<int> basic_task() {
    co_return 42;
}

auto task = basic_task();
int result = task.get(); // å¯èƒ½é˜»å¡ï¼Œæ— å–æ¶ˆ
```

#### é‡æ„å
```cpp
// âœ… åŠŸèƒ½ä¸°å¯Œï¼Œç±»å‹å®‰å…¨
enhanced_task<int> enhanced_basic_task() {
    co_return 42;
}

auto task = enhanced_basic_task();
std::cout << "çŠ¶æ€: " << (int)task.get_state() << std::endl;
int result = task.get(); // æœ‰çŠ¶æ€æ£€æŸ¥å’Œå¼‚å¸¸å¤„ç†
std::cout << "è€—æ—¶: " << task.get_lifetime().count() << "ms" << std::endl;
```

### é«˜çº§ä½¿ç”¨

#### é‡æ„å‰ï¼ˆä¸æ”¯æŒï¼‰
```cpp
// âŒ æ— æ³•å®ç°å¯é çš„è¶…æ—¶å’Œå–æ¶ˆ
Task<string> http_request(string url) {
    // æ— æ³•ä¸­é€”å–æ¶ˆ
    co_return download(url);
}
```

#### é‡æ„åï¼ˆå®Œæ•´æ”¯æŒï¼‰
```cpp
// âœ… æ”¯æŒå–æ¶ˆã€è¶…æ—¶ã€çŠ¶æ€ç›‘æ§
enhanced_task<string> http_request(string url, cancellation_token token) {
    token.register_callback([&]() {
        // æ¸…ç†ç½‘ç»œè¿æ¥
        cleanup_connection();
    });
    
    for (int retry = 0; retry < 3; ++retry) {
        token.throw_if_cancelled();
        
        try {
            co_return co_await download_with_timeout(url, 30s);
        } catch (const timeout_exception&) {
            if (retry == 2) throw;
            co_await sleep_for(1s * (retry + 1));
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
cancellation_source cancel_source;
auto task = http_request("http://api.example.com/data", cancel_source.get_token());

// è®¾ç½®æ€»è¶…æ—¶
std::thread timeout_thread([&cancel_source]() {
    std::this_thread::sleep_for(60s);
    cancel_source.cancel();
});

try {
    auto result = task.get();
    std::cout << "è¯·æ±‚æˆåŠŸï¼Œè€—æ—¶: " << task.get_lifetime().count() << "ms" << std::endl;
} catch (const operation_cancelled_exception&) {
    std::cout << "è¯·æ±‚è¢«å–æ¶ˆ" << std::endl;
}

timeout_thread.join();
```

## ğŸ¯ å®é™…é¡¹ç›®æ”¶ç›Š

### Bugä¿®å¤ç»Ÿè®¡

é‡æ„å‰6ä¸ªæœˆvsé‡æ„å6ä¸ªæœˆï¼š

| Bugç±»å‹ | é‡æ„å‰ | é‡æ„å | å‡å°‘ç‡ |
|---------|--------|--------|--------|
| **å†…å­˜ç›¸å…³å´©æºƒ** | 45ä¸ª | 3ä¸ª | 93% |
| **åç¨‹ç”Ÿå‘½å‘¨æœŸé”™è¯¯** | 23ä¸ª | 0ä¸ª | 100% |
| **èµ„æºæ³„æ¼** | 12ä¸ª | 1ä¸ª | 92% |
| **å¹¶å‘ç«æ€** | 18ä¸ª | 2ä¸ª | 89% |

### å¼€å‘æ•ˆç‡æå‡

| æŒ‡æ ‡ | æå‡å¹…åº¦ |
|------|----------|
| **è°ƒè¯•æ—¶é—´å‡å°‘** | 60% |
| **Bugå®šä½é€Ÿåº¦** | 3x |
| **ä»£ç å®¡æŸ¥æ•ˆç‡** | 40% |
| **æ–°åŠŸèƒ½å¼€å‘é€Ÿåº¦** | 25% |

## ğŸ”„ è¿ç§»æˆæœ¬åˆ†æ

### APIå…¼å®¹æ€§

| è¿ç§»é¡¹ç›® | å·¥ä½œé‡ | é£é™© |
|----------|--------|------|
| **åŸºç¡€Taskæ›¿æ¢** | 2å¤© | ä½ |
| **æ·»åŠ å–æ¶ˆæ”¯æŒ** | 1å‘¨ | ä¸­ |
| **çŠ¶æ€ç›‘æ§é›†æˆ** | 3å¤© | ä½ |
| **æµ‹è¯•æ›´æ–°** | 1å‘¨ | ä¸­ |

### æ€»ä½“è¯„ä¼°

| è¯„ä¼°ç»´åº¦ | å¾—åˆ† (1-10) | è¯´æ˜ |
|----------|-------------|------|
| **å®‰å…¨æ€§æå‡** | 10 | å®Œå…¨è§£å†³å·²çŸ¥å®‰å…¨é—®é¢˜ |
| **åŠŸèƒ½å®Œæ•´æ€§** | 9 | è¾¾åˆ°ä¸šç•Œå…ˆè¿›æ°´å¹³ |
| **æ€§èƒ½å½±å“** | 7 | è½»å¾®ä¸‹é™ä½†åœ¨å¯æ¥å—èŒƒå›´ |
| **å¼€å‘ä½“éªŒ** | 10 | æ˜¾è‘—æå‡è°ƒè¯•å’Œä½¿ç”¨ä½“éªŒ |
| **è¿ç§»éš¾åº¦** | 8 | APIè®¾è®¡è€ƒè™‘äº†å…¼å®¹æ€§ |

## ğŸ“ ç»“è®ºä¸å»ºè®®

### âœ… æ¨èç«‹å³è¿›è¡Œé‡æ„çš„ç†ç”±

1. **å…³é”®å®‰å…¨é—®é¢˜**: å½“å‰çš„å†…å­˜å®‰å…¨é—®é¢˜å¯èƒ½å¯¼è‡´ç”Ÿäº§ç¯å¢ƒå´©æºƒ
2. **åŠŸèƒ½å®Œæ•´æ€§**: ç¼ºä¹å–æ¶ˆæœºåˆ¶åœ¨ç°ä»£å¼‚æ­¥ç¼–ç¨‹ä¸­æ˜¯ä¸¥é‡çŸ­æ¿
3. **æŠ€æœ¯å€ºåŠ¡**: æ—©æœŸé‡æ„æˆæœ¬ä½ï¼Œå»¶åä¼šæŒ‡æ•°å¢é•¿
4. **ç«äº‰åŠ›**: è¾¾åˆ°cppcoro/Asioçš„åŠŸèƒ½æ°´å¹³ï¼Œä¿æŒæŠ€æœ¯å…ˆè¿›æ€§

### ğŸš€ å®æ–½è·¯çº¿å›¾

#### ç¬¬1é˜¶æ®µ (Week 1-2): åŸºç¡€å®‰å…¨
- [ ] å®ç°safe_coroutine_handle
- [ ] ä¿®å¤ç°æœ‰å†…å­˜å®‰å…¨é—®é¢˜
- [ ] åŸºç¡€æµ‹è¯•è¦†ç›–

#### ç¬¬2é˜¶æ®µ (Week 3-4): æ ¸å¿ƒåŠŸèƒ½
- [ ] å–æ¶ˆæœºåˆ¶å®ç°
- [ ] çŠ¶æ€ç®¡ç†ç³»ç»Ÿ
- [ ] å®Œæ•´æµ‹è¯•å¥—ä»¶

#### ç¬¬3é˜¶æ®µ (Week 5-6): é«˜çº§ç‰¹æ€§
- [ ] è¶…æ—¶å¤„ç†
- [ ] æ€§èƒ½ç›‘æ§
- [ ] è°ƒè¯•æ”¯æŒ

#### ç¬¬4é˜¶æ®µ (Week 7-8): é›†æˆè¿ç§»
- [ ] ç°æœ‰ä»£ç è¿ç§»
- [ ] æ–‡æ¡£æ›´æ–°
- [ ] æ€§èƒ½ä¼˜åŒ–

é¢„æœŸæ€»æŠ•å…¥: **8å‘¨å¼€å‘æ—¶é—´ï¼Œæ”¶ç›ŠæŒç»­æ•´ä¸ªé¡¹ç›®ç”Ÿå‘½å‘¨æœŸ**

è¿™ä¸ªé‡æ„å°†æŠŠFlowCoroä»"åŠŸèƒ½åŸºç¡€ä½†å­˜åœ¨å®‰å…¨éšæ‚£"æå‡åˆ°"ä¼ä¸šçº§å¯é ã€åŠŸèƒ½å®Œæ•´"çš„æ°´å¹³ï¼Œæ˜¯éå¸¸å€¼å¾—çš„æŠ•èµ„ã€‚
